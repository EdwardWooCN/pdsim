

# Not a .NET project, we build Astropy in the install step instead
build: false

# Taken from SpiceyPy with some modification
environment:
  global:
      WITH_COMPILER: "cmd /E:ON /V:ON /C .\\appveyor\\windows_sdk.cmd"
  PYPI_PASSWORD:
    secure: JjNZdPH3xLhd2obfOsF5YA==

  matrix:
      - PYTHON: "C:\\Python27-x64"
        PYTHON_VERSION: "2.7.x"
        ARCH: "64"
        PLAT_NAME: "win-amd64"
        PY_TAG: "cp27"

platform:
    -x64

install:
  # Log out the python version just so we know it
  - ECHO "%PYTHON_VERSION%"

  # update path to use installed pip
  - set PATH=%PYTHON%\\scripts;%PATH%

  # Download things we absolutely need
  - pip install wheel twine six numpy wxpython cython h5py matplotlib
  - pip install --pre --trusted-host www.coolprop.dreamhosters.com --find-links http://www.coolprop.dreamhosters.com/binaries/Python/ -U --force-reinstall CoolProp

  # Now install PDSim
  - "%PYTHON%/python setup.py install"

  - ECHO "Installed PDSim"

test_script:
    - "cd examples && %PYTHON%/python simple_example.py"

after_test:
  - ECHO "DONE!"
  - ECHO "BUILDING WHEELS..."
  - "%PYTHON%/python setup.py bdist_wheel --plat-name=%PLAT_NAME%"
  
artifacts:
  - path: dist\*
    name: pypi_artifacts

# Thanks to https://github.com/AndrewAnnex/SpiceyPy/blob/master/appveyor.yml
deploy_script:
  - ls -l dist\*.*
  - echo "Starting Artifact Deployment"
  # populate pypirc file for twine
  - echo [distutils]                                  > %USERPROFILE%\\.pypirc
  - echo index-servers =                             >> %USERPROFILE%\\.pypirc
  - echo     pypi                                    >> %USERPROFILE%\\.pypirc
  - echo [pypi]                                      >> %USERPROFILE%\\.pypirc
  - echo username=belli                              >> %USERPROFILE%\\.pypirc
  - echo password=%PYPI_PASSWORD%                    >> %USERPROFILE%\\.pypirc
  # upload to pypi for windows
  - set PATH=%BK_PATH%
  - set HOME=%USERPROFILE%
  - ps: If ($env:APPVEYOR_REPO_TAG -eq "true" -And $env:APPVEYOR_REPO_BRANCH -eq "master") { Invoke-Expression "twine upload --skip-existing dist/*.whl" 2>$null } Else { write-output "Not on a tag on master, won't deploy to pypi"}
  - echo "Finished Artifact Deployment to PYPI"
